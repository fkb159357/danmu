<!DOCTYPE html>
<html>
    <head>
        <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
        <style type="text/css">
            #drop-area{
                width: 500px;
                height: 300px;
                text-align: center;
                line-height: 300px;
                font-size: 36px;
                font-weight: bolder;
                background-color: #dddddd;
                border: dotted 3px #999;
            }
            #files-area>li>span{
                display: inline-block;
                margin-right: 20px;
            }
        </style>
    </head>
    <body>
        <div id="drop-area">拖放图片到此处</div>
        <ul id="files-area"></ul>

        <script>
            var dropArea = document.getElementById('drop-area');
            var filesArea = document.getElementById('files-area');

            function initDrop(callback){
                dropArea.addEventListener('dragenter', function(evt){
                    filesArea.innerHTML = '';
                    evt.stopPropagation();
                    evt.preventDefault();
                }, false);
                dropArea.addEventListener('dragover', function(evt){
                    evt.stopPropagation();
                    evt.preventDefault();
                }, false);
                dropArea.addEventListener('drop', function(evt){
                    evt.stopPropagation();
                    evt.preventDefault();
                    callback.call(this, evt);
                }, false);
            }

            initDrop(function(evt){
                var files = evt.dataTransfer.files;
                for (var i = 0; i < files.length; i ++) {
                    var file = files[i];
                    if (-1 != ['image/jpeg', 'image/png', 'image/gif'].indexOf(file.type.toLowerCase())) {
                        var fileLi = renderFileBeforeUp(file, filesArea);
                        upFile(file, {
                            progressbar: fileLi.getElementsByClassName('up-progress')[0],
                            loading: fileLi.getElementsByClassName('up-loading')[0], 
                            srcBar: fileLi.getElementsByClassName('img-src')[0],
                            preview: fileLi.getElementsByClassName('img-preview')[0],
                        });
                    }
                }
            });

            function renderFileBeforeUp(file, filesArea){
                var li = document.createElement('li');
                var span = document.createElement('span');
                span.innerText = file.name + ' [' + file.size + 'Bytes]';
                var progress = document.createElement('span');
                progress.innerText = '0%';
                progress.className = 'up-progress';
                var loading = document.createElement('img');
                loading.src = 'http://s1.dwstatic.com/duowanvideo/20170503/09/5103534.gif';
                loading.className = 'up-loading';
                loading.width = 20;
                loading.height = 20;
                var src = document.createElement('div');
                src.className = 'img-src';
                src.style.color = 'blue';
                var preview = new Image();
                preview.className = 'img-preview';
                preview.style.display = 'none';
                preview.height = 80;
                li.appendChild(span);
                li.appendChild(loading);
                li.appendChild(progress);
                li.appendChild(src);
                li.appendChild(preview);
                filesArea.appendChild(li);
                return li;
            }

            function upFile(file, options){
                var xhr = new XMLHttpRequest();
                xhr.addEventListener('progress', function(evt){
                    if (evt.lengthComputable) {
                        var perc = Math.round(evt.loaded * 100) / evt.total;
                        if (perc < 100) {
                            options.progressbar.innerText = perc + '%';
                        }
                    }
                }, false);
                xhr.addEventListener('load', function(evt){
                    var jsonText = xhr.responseText;
                    var j = JSON.parse(jsonText);
                    options.loading.style.display = 'none';
                    if (j.code != 0) {
                        options.srcBar.innerText = j.msg;
                    } else {
                        options.progressbar.innerText = '100%';
                        options.srcBar.innerText = j.data.url;
                        options.preview.src = j.data.url;
                        options.preview.style.display = '';
                    }
                }, false);
                xhr.addEventListener('error', function(error){
                    alert('error: ' + error);
                }, false);
                xhr.open('POST', '/?tu/up', true);
                var fd = new FormData();
                fd.append('tu', file);
                fd.append('tmp', 1);
                xhr.send(fd);
            }
        </script>

        <div>
            <span class="inputTitle">打标签：</span>
            <input id="tags" type="text">
            <input id="setTags" type="button" value="打上">(按下回车出候选提示)
        </div>
    </body>
</html>